name: PR Release Validation

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test-goreleaser:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.24.1
          cache: true

      - name: Download Go dependencies
        run: |
          echo "Downloading Go modules..."
          go mod download
          echo "Go modules downloaded successfully"

      - name: Install osslsigncode
        run: |
          sudo apt-get update
          sudo apt-get install -y osslsigncode

      - name: Generate self-signed test certificates
        run: |
          # Generate a private key
          openssl genrsa -out test-key.pem 2048
          
          # Generate a self-signed certificate
          openssl req -new -x509 -key test-key.pem -out test-cert.pem -days 1 \
            -subj "/C=US/ST=Test/L=Test/O=SailPoint Test/CN=SailPoint CLI Test"
          
          # Export paths
          echo "CERT_FILE=$(pwd)/test-cert.pem" >> $GITHUB_ENV
          echo "KEY_FILE=$(pwd)/test-key.pem" >> $GITHUB_ENV

      - name: Set test version
        run: echo "RELEASE_VERSION=0.0.0-test" >> $GITHUB_ENV

      - name: Verify environment
        run: |
          echo "=== Environment Check ==="
          which osslsigncode
          osslsigncode --version || echo "osslsigncode version check failed"
          ls -la test-*.pem
          echo "CERT_FILE=$CERT_FILE"
          echo "KEY_FILE=$KEY_FILE"
          go version
          echo "=== System Resources ==="
          free -h
          df -h
          echo "=== Starting GoReleaser ==="

      - name: Install GoReleaser
        run: |
          wget -q https://github.com/goreleaser/goreleaser/releases/download/v2.8.2/goreleaser_Linux_x86_64.tar.gz
          tar -xzf goreleaser_Linux_x86_64.tar.gz
          sudo mv goreleaser /usr/local/bin/
          goreleaser --version

      - name: Run GoReleaser in Snapshot Mode
        continue-on-error: true
        id: goreleaser
        run: |
          set +e  # Don't exit on error
          
          # Monitor resources in background
          (while true; do
            echo "=== $(date) - Memory usage ==="
            free -h | grep Mem
            sleep 30
          done) &
          MONITOR_PID=$!
          
          goreleaser release --snapshot --clean --skip=publish --timeout 45m --config .goreleaser.test.yaml --parallelism 2 --verbose
          EXIT_CODE=$?
          
          # Stop monitoring
          kill $MONITOR_PID 2>/dev/null || true
          
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          exit $EXIT_CODE
        env:
          GORELEASER_CURRENT_TAG: "v0.0.0-test"
          CERT_PASSWORD: "test"

      - name: Check GoReleaser result
        if: always()
        run: |
          echo "GoReleaser exit code: ${{ steps.goreleaser.outputs.exit_code }}"
          echo "Step outcome: ${{ steps.goreleaser.outcome }}"
          if [ -d dist ]; then
            echo "=== Dist directory contents ==="
            ls -lR dist/ || true
          else
            echo "No dist directory found"
          fi
          
          # Show last 100 lines of any build logs if they exist
          if [ -d dist ]; then
            find dist -name "*.log" -exec echo "=== {} ===" \; -exec tail -50 {} \; || true
          fi

      - name: Upload artifacts for inspection
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-release-artifacts
          path: dist/
          retention-days: 7
          if-no-files-found: warn

